access_method=oslogin,name=faulty-linux-ssh,principal=user:cannotssh@example.com,project_id=gcpdiag-
gce-faultyssh-runbook,proxy=iap,zone=europe-west2-a

gce/ssh: A comprehensive troubleshooting guide for common issues which affects SSH connectivity to VMs.

  Investigates components required for ssh on either Windows and Linux VMs
  hosted on Google Cloud Platform and pinpoint misconfigurations.

  Areas Examined:

  - VM Instance Status: Evaluates the VM's current state, performance - ensuring that it is running
    and not impaired by high CPU usage, insufficient memory, or disk space issues that might disrupt
    normal SSH operations.

  - User Permissions: Checks for the necessary Google Cloud IAM permissions that are required to
    leverage OS Login features and to use metadata-based SSH keys for authentication.

  - VM Configuration: Analyzes the VM's metadata settings to confirm the inclusion of SSH keys,
    flags and other essential configuration details that facilitate SSH access.

  - GCE Network Connectivity Tests: Reviews applicable firewall rules to verify that there are no
    network barriers preventing SSH access to the VM.

  - Internal Guest OS Checks: Analysis available Guest OS metrics or logs to detect any
    misconfigurations or service disruptions that could be obstructing SSH functionality.

  - SSH in Browser Checks: Checks if the authenticated user has relevant permissions and
    the organization policies permits SSH in Browser.
    
[START]: Starting SSH diagnostics
[INFO]: Source IP to be used for SSH connectivity test: 35.235.240.0/20
[INFO]: Port 22 and ip 35.235.240.0/20 as the source IP
[INFO]: Access method to investigate: OS login https://cloud.google.com/compute/docs/oslogin
[AUTOMATED STEP]: Verify GCE Instance is in a "RUNNING" state.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [OK]
     [REASON]
     The GCE Instance projects/gcpdiag-gce-faultyssh-runbook/zones/europe-west2-a/instances/faulty-linux-ssh is in RUNNING state.

[COMPOSITE STEP]: Evaluating VM memory, CPU, and disk performance.
[AUTOMATED STEP]: Verify VM memory utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [FAIL]
     [REASON]
     Memory utilization on this VM has reached levels that may compromise its VM application performance.

     [REMEDIATION]
     Elevated memory usage can result in slow or unresponsive or termimated applications.
     Consider enhancing the VM's memory capacity by changing to a machine type with more memory.
     Guidance on stopping and changing the machine type can be found here:
     - Changing machine type:
     https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     For deeper analysis of memory issues:

     Additionally, use the Compute Engine observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#memory_utilization

     Or connect via the Serial Console if SSH is not available to mitigate the issue.
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

[AUTOMATED STEP]: Check for memory related errors in VM serial logs.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [UNCERTAIN]
     [REASON]
     Unable to investigate the high memory utilization error logs, likely due to the absence of logs.
     However, this does not eliminate the possibility of high memory usage.

     You may manually verify memory utilization on the Guest OS side a likely cause.

     [REMEDIATION]
     1. Manually investigate by accessing the Guest OS to Analyze Memory Usage:
     * Identify processes with consistently high memory consumption:
     - Run `top` and press "M" to sort processes by memory usage.
     - Alternatively, use the command:
     ```bash
     ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -n 5
     ```
     * Focus on processes with recent spikes or consistently high memory usage.
     * If SSH access is unavailable, consider [troubleshooting via the serial
     console](https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console).

     2. Review Application or Configuration Changes:
     * Investigate if recent deployments, updates, or configuration changes correlate with increased memory usage.

     3. Resolve Identified Bottlenecks:
     * For applications causing excessive memory usage:
     - Optimize their configuration or update them to a stable version.
     - Explore alternatives if optimization is insufficient.
     * Evaluate scaling up resources if the high memory usage results from legitimate application demands.

     4. Increase Instance Memory if Necessary:
     * If additional memory is required for the application:
     - Stop the VM and [change its machine
     type](https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud).
     - Consult the [machine type documentation](https://cloud.google.com/compute/docs/machine-types) to select an appropriate
     configuration.

     **Note:**
     Non Google provided Application-specific issues may fall outside support scope. Collaborate with
     relevant application teams for further investigation.
     Refer to the [Google Cloud Platform support
     policy](https://cloud.google.com/compute/docs/images/support-maintenance-policy#support-scope)
     for details, including [out-of-scope
     items](https://cloud.google.com/compute/docs/images/support-maintenance-policy#out-of-scope_for_support).

[AUTOMATED STEP]: Check if VM's boot disk space utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [FAIL]
     [REASON]
     Disk utilization on this VM's boot disk is critically high,
     potentially affecting application performance.

     [REMEDIATION]
     To mitigate high disk usage, consider expanding the VM's boot disk capacity.
     This action can help avoid performance issues and ensure smoother SSH connections.
     Follow the guide to increase disk size:
     https://cloud.google.com/compute/docs/disks/resize-persistent-disk#increase_the_size_of_a_disk

[AUTOMATED STEP]: Verify VM CPU utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [FAIL]
     [REASON]
     CPU utilization on this VM has surpassed recommended operational levels,
     which may affect its performance and SSH connectivity.

     [REMEDIATION]
     Excessive CPU usage can lead to performance bottlenecks. Consider resizing the VM to a more
     powerful machine type with higher CPU capabilities.
     Detailed instructions for resizing and restarting VMs are available here:
     - Stopping a VM: https://cloud.google.com/compute/docs/instances/stop-start-instance
     - Resizing a VM: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     Additionally, use the Compute Engine observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#access_vm_observability_metrics
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#process_utilization

     Alternatively, you can connect via serial console if SSH is unvailable to stop offending processes
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console.

[GATEWAY]: Identify Guest OS type.
[INFO]: Linux Guest OS detected. Proceeding with diagnostics specific to Linux systems.
[COMPOSITE STEP]: Analyzing serial logs for common linux guest os and application issues.
[AUTOMATED STEP]: Examine Guest OS if there are any indications of kernel panic.
[AUTOMATED STEP]: Verify OpenSSH daemon (sshd) has started from most recent serial logs.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [OK]
     [REASON]
     The latest OpenSSH daemon (sshd) logs indicate that the daemon has started.

[AUTOMATED STEP]: Verify if SSHGuard is installed and blocking SSH connectivity

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [UNCERTAIN]
     [REASON]
     The retrieved logs do not contain definitive entries, either positive or negative,
     to make a conclusive assessment.
     Manually review the GCE serial logs to determine if SSHGuard is a likely cause.

     [REMEDIATION]
     Note: Issues related to SSHGuard fall outside the standard support scope for Google Cloud Platform.
     Consult the most appropriate team within your organisation to assist with resolution.
     For guest OS issues and SSHGuard configurations, refer to:
     - Support Scope: https://cloud.google.com/compute/docs/images/support-maintenance-policy#support-scope
     - Out of Scope Support: https://cloud.google.com/compute/docs/images/support-maintenance-policy#out-of-scope_for_support

[COMPOSITE STEP]: Verify overall user permissions for SSH access

    Note: Only roles granted at the project level are checked. Permissions inherited from
    ancestor resources such as folder(s) or organization and groups are not checked.
[AUTOMATED STEP]: Verify that the principal has "compute.instance.get" permission.

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     The authenticated user user:cannotssh@example.com does not have the permissions needed to manage instances.
     The following permissions are required: permissions.

     [REMEDIATION]
     To remedy this, ensure the user user:cannotssh@example.com is granted a role encompassing the necessary permissions:
     - Permissions needed: compute.instances.get
     For guidance on assigning instance admin roles, consult:
     https://cloud.google.com/compute/docs/access/iam#connectinginstanceadmin

[GATEWAY]: Identify OS Login Setup.
[AUTOMATED STEP]: Verify that OS Login is set to `True` for the VM.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [FAIL]
     [REASON]
     OS Login is disabled

     [REMEDIATION]
     To utilize OS Login, enable it by setting the `enable-oslogin` flag in the VM's
     metadata to `TRUE`.For detailed instructions on enabling OS Login,
     refer to: https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#enable_os_login

[AUTOMATED STEP]: Verify whether principal has at least one valid OS login role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     "user:cannotssh@example.com" is missing at least one of the required OS Login roles:
     roles/compute.osAdminLogin, roles/compute.osLogin, roles/owner.

     [REMEDIATION]
     Assign the principal one of the role required to have OS Login privileges.
     For more information:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[AUTOMATED STEP]: Verify that the principal has "roles/iam.serviceAccountUser" role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     "user:cannotssh@example.com" does not have the "roles/iam.serviceAccountUser" role or custom roles which has the
     constituent permissions required to be able to impersonate the attached service account.

     [REMEDIATION]
     Assign the "roles/iam.serviceAccountUser" role to "user:cannotssh@example.com".
     Guidelines:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[AUTOMATED STEP]: Verify that the principal has "roles/iap.tunnelResourceAccessor" role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     principal does not have the "roles/iap.tunnelResourceAccessor" role necessary to Tunnel through IAP for access.

     [REMEDIATION]
     Ensure that "user:cannotssh@example.com" is assigned the "roles/iap.tunnelResourceAccessor" role to enable the required access.

     For detailed guidance, refer to the following resources:
     - [Setting up OS Login](https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users)
     - [Managing access to service
     accounts](https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role)

[GATEWAY]: Evaluating VPC network firewall rules for SSH access.
[AUTOMATED STEP]: Evaluating VPC network traffic rules.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [OK]
     [REASON]
     Ingress Traffic from source IP/CIDR 35.235.240.0/20, tcp:22 to the GCE
     instance faulty-linux-ssh is allowed by: vpc firewall rule: gce-secured-instance-test-allow

[AUTOMATED STEP]: Checking for Guest Agent startup logs

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [OK]
     [REASON]
     Detected that Google Guest Agent is running within the VM

[AUTOMATED STEP]: Examining SSHD authentication failures via serial logs.

   - gcpdiag-gce-faultyssh-runbook/faulty-linux-ssh                       [UNCERTAIN]
     [REASON]
     No evidence of successful or failed SSHD authentication attempts is present in the serial logs.

     [REMEDIATION]
     To mitigate "bad ownership or modes for directory" errors:
     1. Follow either of the below steps to check the permissions:
     a. these steps to rescue the vm:
     https://cloud.google.com/compute/docs/troubleshooting/rescue-vm

     b. these steps login through serial console:
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

     2. Refer to the standard permissions required for ssh connection:
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-ssh-errors#permissions

[END]: Finalize SSH diagnostics.


access_method=oslogin,name=valid-linux-ssh,principal=serviceAccount:canssh@gcpdiag-gce-faultyssh-
runbook.iam.gserviceaccount.com,project_id=gcpdiag-gce-faultyssh-runbook,proxy=iap,zone=europe-
west2-a

gce/ssh: A comprehensive troubleshooting guide for common issues which affects SSH connectivity to VMs.

  Investigates components required for ssh on either Windows and Linux VMs
  hosted on Google Cloud Platform and pinpoint misconfigurations.

  Areas Examined:

  - VM Instance Status: Evaluates the VM's current state, performance - ensuring that it is running
    and not impaired by high CPU usage, insufficient memory, or disk space issues that might disrupt
    normal SSH operations.

  - User Permissions: Checks for the necessary Google Cloud IAM permissions that are required to
    leverage OS Login features and to use metadata-based SSH keys for authentication.

  - VM Configuration: Analyzes the VM's metadata settings to confirm the inclusion of SSH keys,
    flags and other essential configuration details that facilitate SSH access.

  - GCE Network Connectivity Tests: Reviews applicable firewall rules to verify that there are no
    network barriers preventing SSH access to the VM.

  - Internal Guest OS Checks: Analysis available Guest OS metrics or logs to detect any
    misconfigurations or service disruptions that could be obstructing SSH functionality.

  - SSH in Browser Checks: Checks if the authenticated user has relevant permissions and
    the organization policies permits SSH in Browser.
    
[START]: Starting SSH diagnostics
[INFO]: Source IP to be used for SSH connectivity test: 35.235.240.0/20
[INFO]: Port 22 and ip 35.235.240.0/20 as the source IP
[INFO]: Access method to investigate: OS login https://cloud.google.com/compute/docs/oslogin
[AUTOMATED STEP]: Verify GCE Instance is in a "RUNNING" state.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     The GCE Instance projects/gcpdiag-gce-faultyssh-runbook/zones/europe-west2-a/instances/valid-linux-ssh is in RUNNING state.

[COMPOSITE STEP]: Evaluating VM memory, CPU, and disk performance.
[AUTOMATED STEP]: Verify VM memory utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [FAIL]
     [REASON]
     Memory utilization on this VM has reached levels that may compromise its VM application performance.

     [REMEDIATION]
     Elevated memory usage can result in slow or unresponsive or termimated applications.
     Consider enhancing the VM's memory capacity by changing to a machine type with more memory.
     Guidance on stopping and changing the machine type can be found here:
     - Changing machine type:
     https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     For deeper analysis of memory issues:

     Additionally, use the Compute Engine observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#memory_utilization

     Or connect via the Serial Console if SSH is not available to mitigate the issue.
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

[AUTOMATED STEP]: Check for memory related errors in VM serial logs.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [UNCERTAIN]
     [REASON]
     Unable to investigate the high memory utilization error logs, likely due to the absence of logs.
     However, this does not eliminate the possibility of high memory usage.

     You may manually verify memory utilization on the Guest OS side a likely cause.

     [REMEDIATION]
     1. Manually investigate by accessing the Guest OS to Analyze Memory Usage:
     * Identify processes with consistently high memory consumption:
     - Run `top` and press "M" to sort processes by memory usage.
     - Alternatively, use the command:
     ```bash
     ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -n 5
     ```
     * Focus on processes with recent spikes or consistently high memory usage.
     * If SSH access is unavailable, consider [troubleshooting via the serial
     console](https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console).

     2. Review Application or Configuration Changes:
     * Investigate if recent deployments, updates, or configuration changes correlate with increased memory usage.

     3. Resolve Identified Bottlenecks:
     * For applications causing excessive memory usage:
     - Optimize their configuration or update them to a stable version.
     - Explore alternatives if optimization is insufficient.
     * Evaluate scaling up resources if the high memory usage results from legitimate application demands.

     4. Increase Instance Memory if Necessary:
     * If additional memory is required for the application:
     - Stop the VM and [change its machine
     type](https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud).
     - Consult the [machine type documentation](https://cloud.google.com/compute/docs/machine-types) to select an appropriate
     configuration.

     **Note:**
     Non Google provided Application-specific issues may fall outside support scope. Collaborate with
     relevant application teams for further investigation.
     Refer to the [Google Cloud Platform support
     policy](https://cloud.google.com/compute/docs/images/support-maintenance-policy#support-scope)
     for details, including [out-of-scope
     items](https://cloud.google.com/compute/docs/images/support-maintenance-policy#out-of-scope_for_support).

[AUTOMATED STEP]: Check if VM's boot disk space utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [FAIL]
     [REASON]
     Disk utilization on this VM's boot disk is critically high,
     potentially affecting application performance.

     [REMEDIATION]
     To mitigate high disk usage, consider expanding the VM's boot disk capacity.
     This action can help avoid performance issues and ensure smoother SSH connections.
     Follow the guide to increase disk size:
     https://cloud.google.com/compute/docs/disks/resize-persistent-disk#increase_the_size_of_a_disk

[AUTOMATED STEP]: Verify VM CPU utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [FAIL]
     [REASON]
     CPU utilization on this VM has surpassed recommended operational levels,
     which may affect its performance and SSH connectivity.

     [REMEDIATION]
     Excessive CPU usage can lead to performance bottlenecks. Consider resizing the VM to a more
     powerful machine type with higher CPU capabilities.
     Detailed instructions for resizing and restarting VMs are available here:
     - Stopping a VM: https://cloud.google.com/compute/docs/instances/stop-start-instance
     - Resizing a VM: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     Additionally, use the Compute Engine observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#access_vm_observability_metrics
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#process_utilization

     Alternatively, you can connect via serial console if SSH is unvailable to stop offending processes
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console.

[GATEWAY]: Identify Guest OS type.
[INFO]: Linux Guest OS detected. Proceeding with diagnostics specific to Linux systems.
[COMPOSITE STEP]: Analyzing serial logs for common linux guest os and application issues.
[AUTOMATED STEP]: Examine Guest OS if there are any indications of kernel panic.
[AUTOMATED STEP]: Verify OpenSSH daemon (sshd) has started from most recent serial logs.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     The latest OpenSSH daemon (sshd) logs indicate that the daemon has started.

[AUTOMATED STEP]: Verify if SSHGuard is installed and blocking SSH connectivity

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [UNCERTAIN]
     [REASON]
     The retrieved logs do not contain definitive entries, either positive or negative,
     to make a conclusive assessment.
     Manually review the GCE serial logs to determine if SSHGuard is a likely cause.

     [REMEDIATION]
     Note: Issues related to SSHGuard fall outside the standard support scope for Google Cloud Platform.
     Consult the most appropriate team within your organisation to assist with resolution.
     For guest OS issues and SSHGuard configurations, refer to:
     - Support Scope: https://cloud.google.com/compute/docs/images/support-maintenance-policy#support-scope
     - Out of Scope Support: https://cloud.google.com/compute/docs/images/support-maintenance-policy#out-of-scope_for_support

[COMPOSITE STEP]: Verify overall user permissions for SSH access

    Note: Only roles granted at the project level are checked. Permissions inherited from
    ancestor resources such as folder(s) or organization and groups are not checked.
[AUTOMATED STEP]: Verify that the principal has "compute.instance.get" permission.

   - projects/gcpdiag-gce-faultyssh-runbook                               [OK]
     [REASON]
     The user serviceAccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com possesses the appropriate permissions to fetch instance details.

[GATEWAY]: Identify OS Login Setup.
[AUTOMATED STEP]: Verify that OS Login is set to `True` for the VM.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     OS Login is enabled on this VM.

[AUTOMATED STEP]: Verify whether principal has at least one valid OS login role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [OK]
     [REASON]
     "serviceAccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com" possesses at least one of the required OS Login roles:
     roles/compute.osAdminLogin, roles/compute.osLogin, roles/owner.

[AUTOMATED STEP]: Verify that the principal has "roles/iam.serviceAccountUser" role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [OK]
     [REASON]
     "serviceAccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com" has the "roles/iam.serviceAccountUser"
     required to impersonate the attached service account.

[AUTOMATED STEP]: Verify that the principal has "roles/iap.tunnelResourceAccessor" role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [OK]
     [REASON]
     "serviceAccount:canssh@gcpdiag-gce-faultyssh-runbook.iam.gserviceaccount.com" has the requisite "roles/iap.tunnelResourceAccessor" role to tunnel through IAP.

[GATEWAY]: Evaluating VPC network firewall rules for SSH access.
[AUTOMATED STEP]: Evaluating VPC network traffic rules.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     Ingress Traffic from source IP/CIDR 35.235.240.0/20, tcp:22 to the GCE
     instance valid-linux-ssh is allowed by: vpc firewall rule: default-allow-ssh

[AUTOMATED STEP]: Checking for Guest Agent startup logs

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [OK]
     [REASON]
     Detected that Google Guest Agent is running within the VM

[AUTOMATED STEP]: Examining SSHD authentication failures via serial logs.

   - gcpdiag-gce-faultyssh-runbook/valid-linux-ssh                        [UNCERTAIN]
     [REASON]
     No evidence of successful or failed SSHD authentication attempts is present in the serial logs.

     [REMEDIATION]
     To mitigate "bad ownership or modes for directory" errors:
     1. Follow either of the below steps to check the permissions:
     a. these steps to rescue the vm:
     https://cloud.google.com/compute/docs/troubleshooting/rescue-vm

     b. these steps login through serial console:
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

     2. Refer to the standard permissions required for ssh connection:
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-ssh-errors#permissions

[END]: Finalize SSH diagnostics.


access_method=oslogin,name=faulty-windows-
ssh,posix_user=no_user,principal=user:cannot@example.com,project_id=gcpdiag-gce-faultyssh-
runbook,proxy=iap,src_ip=0.0.0.0,zone=europe-west2-a

gce/ssh: A comprehensive troubleshooting guide for common issues which affects SSH connectivity to VMs.

  Investigates components required for ssh on either Windows and Linux VMs
  hosted on Google Cloud Platform and pinpoint misconfigurations.

  Areas Examined:

  - VM Instance Status: Evaluates the VM's current state, performance - ensuring that it is running
    and not impaired by high CPU usage, insufficient memory, or disk space issues that might disrupt
    normal SSH operations.

  - User Permissions: Checks for the necessary Google Cloud IAM permissions that are required to
    leverage OS Login features and to use metadata-based SSH keys for authentication.

  - VM Configuration: Analyzes the VM's metadata settings to confirm the inclusion of SSH keys,
    flags and other essential configuration details that facilitate SSH access.

  - GCE Network Connectivity Tests: Reviews applicable firewall rules to verify that there are no
    network barriers preventing SSH access to the VM.

  - Internal Guest OS Checks: Analysis available Guest OS metrics or logs to detect any
    misconfigurations or service disruptions that could be obstructing SSH functionality.

  - SSH in Browser Checks: Checks if the authenticated user has relevant permissions and
    the organization policies permits SSH in Browser.
    
[START]: Starting SSH diagnostics
[INFO]: Source IP to be used for SSH connectivity test: 35.235.240.0/20
[INFO]: Port 22 and ip 35.235.240.0/20 as the source IP
[INFO]: Access method to investigate: OS login https://cloud.google.com/compute/docs/oslogin
[INFO]: Guest OS Posix User to be investigated: no_user
[AUTOMATED STEP]: Verify GCE Instance is in a "RUNNING" state.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     The GCE Instance projects/gcpdiag-gce-faultyssh-runbook/zones/europe-west2-a/instances/faulty-windows-ssh is not in the TERMINATED.

     [REMEDIATION]
     Restart VM projects/gcpdiag-gce-faultyssh-runbook/zones/europe-west2-a/instances/faulty-windows-ssh and ensure VM lifecycle transitions from TERMINATED to RUNNING.

     You can [restart a compute instance](https://cloud.google.com/compute/docs/instances/stop-start-instance#restart-vm)
     with this guide.

     If you encounter any difficulties starting the VM, consult the [VM Startup troubleshooting
     documentation](https://cloud.google.com/compute/docs/troubleshooting/vm-startup#identify_the_reason_why_the_boot_disk_isnt_booting)
     to identify and resolve potential startup issues.

[COMPOSITE STEP]: Evaluating VM memory, CPU, and disk performance.
[AUTOMATED STEP]: Verify VM memory utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     Memory utilization on this VM has reached levels that may compromise its VM application performance.

     [REMEDIATION]
     Elevated memory usage can result in slow or unresponsive or termimated applications.
     Consider enhancing the VM's memory capacity by changing to a machine type with more memory.
     Guidance on stopping and changing the machine type can be found here:
     - Changing machine type:
     https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     For deeper analysis of memory issues:

     Additionally, use the Compute Engine observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#memory_utilization

     Or connect via the Serial Console if SSH is not available to mitigate the issue.
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

[AUTOMATED STEP]: Check for memory related errors in VM serial logs.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [UNCERTAIN]
     [REASON]
     Unable to investigate the high memory utilization error logs, likely due to the absence of logs.
     However, this does not eliminate the possibility of high memory usage.

     You may manually verify memory utilization on the Guest OS side a likely cause.

     [REMEDIATION]
     1. Manually investigate by accessing the Guest OS to Analyze Memory Usage:
     * Identify processes with consistently high memory consumption:
     - Run `top` and press "M" to sort processes by memory usage.
     - Alternatively, use the command:
     ```bash
     ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -n 5
     ```
     * Focus on processes with recent spikes or consistently high memory usage.
     * If SSH access is unavailable, consider [troubleshooting via the serial
     console](https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console).

     2. Review Application or Configuration Changes:
     * Investigate if recent deployments, updates, or configuration changes correlate with increased memory usage.

     3. Resolve Identified Bottlenecks:
     * For applications causing excessive memory usage:
     - Optimize their configuration or update them to a stable version.
     - Explore alternatives if optimization is insufficient.
     * Evaluate scaling up resources if the high memory usage results from legitimate application demands.

     4. Increase Instance Memory if Necessary:
     * If additional memory is required for the application:
     - Stop the VM and [change its machine
     type](https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud).
     - Consult the [machine type documentation](https://cloud.google.com/compute/docs/machine-types) to select an appropriate
     configuration.

     **Note:**
     Non Google provided Application-specific issues may fall outside support scope. Collaborate with
     relevant application teams for further investigation.
     Refer to the [Google Cloud Platform support
     policy](https://cloud.google.com/compute/docs/images/support-maintenance-policy#support-scope)
     for details, including [out-of-scope
     items](https://cloud.google.com/compute/docs/images/support-maintenance-policy#out-of-scope_for_support).

[AUTOMATED STEP]: Check if VM's boot disk space utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     Disk utilization on this VM's boot disk is critically high,
     potentially affecting application performance.

     [REMEDIATION]
     To mitigate high disk usage, consider expanding the VM's boot disk capacity.
     This action can help avoid performance issues and ensure smoother SSH connections.
     Follow the guide to increase disk size:
     https://cloud.google.com/compute/docs/disks/resize-persistent-disk#increase_the_size_of_a_disk

[AUTOMATED STEP]: Verify VM CPU utilization is within optimal levels.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     CPU utilization on this VM has surpassed recommended operational levels,
     which may affect its performance and SSH connectivity.

     [REMEDIATION]
     Excessive CPU usage can lead to performance bottlenecks. Consider resizing the VM to a more
     powerful machine type with higher CPU capabilities.
     Detailed instructions for resizing and restarting VMs are available here:
     - Stopping a VM: https://cloud.google.com/compute/docs/instances/stop-start-instance
     - Resizing a VM: https://cloud.google.com/compute/docs/instances/changing-machine-type-of-stopped-instance#gcloud
     Additionally, use the Compute Engine observability metrics for an in-depth analysis to pinpoint high-usage processes:
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#access_vm_observability_metrics
     https://cloud.google.com/compute/docs/instances/observe-monitor-vms#process_utilization

     Alternatively, you can connect via serial console if SSH is unvailable to stop offending processes
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console.

[GATEWAY]: Identify Guest OS type.
[INFO]: Windows Guest OS detected. Proceeding with diagnostics specific to Windows systems.
[COMPOSITE STEP]: Analyzing Windows Guest OS boot-up and SSH agent status.
[AUTOMATED STEP]: Verify VM metadata value.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [FAIL]
     [REASON]
     SSH metadata `enable-windows-ssh` is not configured for this Windows VM,
     preventing SSH access.

     [REMEDIATION]
     To enable SSH access for your Windows VM, you must configure SSH metadata settings appropriately.
     Please consult our guide on enabling SSH for Windows instances for step-by-step instructions:
     https://cloud.google.com/compute/docs/connect/windows-ssh#enable

[AUTOMATED STEP]: Verify Windows bootup process have succesfully completed.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [UNCERTAIN]
     [REASON]
     Lack of serial log data prevented a thorough assessment of the VM's operational state. Result is
     inconclusive

     [REMEDIATION]
     Fix boot issues preventing a successful startup. If the Google Compute Engine (GCE) guest agents are installed, the
     startup process should include the expected guest agent logs.

     ### Resources
     1. [Troubleshooting Windows instances](https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-windows)
     2. [Connecting to the Windows Special Administrative Console
     (SAC)](https://cloud.google.com/compute/docs/instances/connecting-to-sac)
     3. [Installing the Windows GCE guest
     environment](https://cloud.google.com/compute/docs/images/install-guest-environment#windows:~:text=Engine%20Shutdown%20Scripts-,Windows,-GCEGuestAgent%3A%20GCE%20Agent)
     4. [Connecting to Windows instances](https://cloud.google.com/compute/docs/instances/connecting-to-windows)
     5. [Connecting to Windows using SSH](https://cloud.google.com/compute/docs/connect/windows-ssh)
     6. [Using PowerShell to connect to Windows
     instances](https://cloud.google.com/compute/docs/instances/windows/connecting-powershell)

[MANUAL STEP]: Manually verify if the necessary Google guest agents, especially `google-compute-engine-ssh`,
are operational on the VM.
[COMPOSITE STEP]: Verify overall user permissions for SSH access

    Note: Only roles granted at the project level are checked. Permissions inherited from
    ancestor resources such as folder(s) or organization and groups are not checked.
[AUTOMATED STEP]: Verify that the principal has "compute.instance.get" permission.

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     The authenticated user user:cannot@example.com does not have the permissions needed to manage instances.
     The following permissions are required: permissions.

     [REMEDIATION]
     To remedy this, ensure the user user:cannot@example.com is granted a role encompassing the necessary permissions:
     - Permissions needed: compute.instances.get
     For guidance on assigning instance admin roles, consult:
     https://cloud.google.com/compute/docs/access/iam#connectinginstanceadmin

[GATEWAY]: Identify OS Login Setup.
[AUTOMATED STEP]: Verify that OS Login is set to `True` for the VM.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [OK]
     [REASON]
     OS Login is enabled on this VM.

[AUTOMATED STEP]: Verify whether principal has at least one valid OS login role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     "user:cannot@example.com" is missing at least one of the required OS Login roles:
     roles/compute.osAdminLogin, roles/compute.osLogin, roles/owner.

     [REMEDIATION]
     Assign the principal one of the role required to have OS Login privileges.
     For more information:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[AUTOMATED STEP]: Verify that the principal has "roles/iam.serviceAccountUser" role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     "user:cannot@example.com" does not have the "roles/iam.serviceAccountUser" role or custom roles which has the
     constituent permissions required to be able to impersonate the attached service account.

     [REMEDIATION]
     Assign the "roles/iam.serviceAccountUser" role to "user:cannot@example.com".
     Guidelines:
     https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users
     https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role

[AUTOMATED STEP]: Verify that the principal has "roles/iap.tunnelResourceAccessor" role.

   - projects/gcpdiag-gce-faultyssh-runbook                               [FAIL]
     [REASON]
     principal does not have the "roles/iap.tunnelResourceAccessor" role necessary to Tunnel through IAP for access.

     [REMEDIATION]
     Ensure that "user:cannot@example.com" is assigned the "roles/iap.tunnelResourceAccessor" role to enable the required access.

     For detailed guidance, refer to the following resources:
     - [Setting up OS Login](https://cloud.google.com/compute/docs/oslogin/set-up-oslogin#configure_users)
     - [Managing access to service
     accounts](https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role)

[GATEWAY]: Evaluating VPC network firewall rules for SSH access.
[AUTOMATED STEP]: Evaluating VPC network traffic rules.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [OK]
     [REASON]
     Ingress Traffic from source IP/CIDR 35.235.240.0/20, tcp:22 to the GCE
     instance faulty-windows-ssh is allowed by: vpc firewall rule: gce-secured-instance-test-allow

[AUTOMATED STEP]: Checking for Guest Agent startup logs

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [UNCERTAIN]
     [REASON]
     No success or failed logs found for Google Guest Agent startup.

     [REMEDIATION]
     The google-guest-agent contains the guest agent and metadata script executables which
     runs on the guest OS to support the Compute Engine features. These features include account
     management, OS Login integration, clock skew, network interface management, and instance setup.

     In case Guest Agent is not started during instance startup, users might face login issues.

     The google-guest-agent.service service should be in running state.
     If the service is disabled, enable and start the service, by running the following commands:

     systemctl enable google-guest-agent.service
     systemctl start google-guest-agent.service

     Verify that the Linux Google Agent scripts are installed and running. If the Linux Google
     Agent is not installed, re-install it.

[AUTOMATED STEP]: Examining SSHD authentication failures via serial logs.

   - gcpdiag-gce-faultyssh-runbook/faulty-windows-ssh                     [UNCERTAIN]
     [REASON]
     No evidence of successful or failed SSHD authentication attempts is present in the serial logs.

     [REMEDIATION]
     To mitigate "bad ownership or modes for directory" errors:
     1. Follow either of the below steps to check the permissions:
     a. these steps to rescue the vm:
     https://cloud.google.com/compute/docs/troubleshooting/rescue-vm

     b. these steps login through serial console:
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-using-serial-console

     2. Refer to the standard permissions required for ssh connection:
     https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-ssh-errors#permissions

[END]: Finalize SSH diagnostics.


